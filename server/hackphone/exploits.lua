-- ================================================
-- HACK PHONE - EXPLOITS & ADVANCED FEATURES
-- ================================================

-- Database query (for police/government roles)
RegisterNetEvent('hackphone:server:databaseQuery', function(hackerDeviceId, queryType, searchTerm)
    local src = source
    
    if not HasHackerPermission(src) then
        SendNotify(src, 'Access denied', 'error')
        return
    end
    
    if GetPlayerMoney(src) < Config.HackPhone.DatabaseQueryCost then
        SendNotify(src, 'Insufficient funds', 'error')
        return
    end
    
    RemovePlayerMoney(src, Config.HackPhone.DatabaseQueryCost)
    
    local results = {}
    
    if queryType == 'phone_number' then
        results = MySQL.query.await([[
            SELECT pd.phone_number, pd.device_id, pd.created_at
            FROM phone_devices pd
            WHERE pd.phone_number LIKE ?
            LIMIT 10
        ]], {'%' .. searchTerm .. '%'})
    elseif queryType == 'recent_calls' then
        results = MySQL.query.await([[
            SELECT * FROM phone_calls
            WHERE caller_account_id = ? OR receiver_account_id = ?
            ORDER BY created_at DESC
            LIMIT 20
        ]], {searchTerm, searchTerm})
    end
    
    -- Log query
    MySQL.insert([[
        INSERT INTO phone_hack_logs (hacker_device_id, target_phone_number, hack_type, hack_data, success)
        VALUES (?, ?, 'db_query', ?, 1)
    ]], {hackerDeviceId, searchTerm, json.encode({query_type = queryType, results_count = #results})})
    
    TriggerClientEvent('hackphone:client:queryResults', src, results)
end)

-- Camera access (RP-based, just logs the attempt)
RegisterNetEvent('hackphone:server:accessCamera', function(hackerDeviceId, targetNumber)
    local src = source
    
    if not HasHackerPermission(src) then
        SendNotify(src, 'Access denied', 'error')
        return
    end
    
    if GetPlayerMoney(src) < Config.HackPhone.CameraAccessCost then
        SendNotify(src, 'Insufficient funds', 'error')
        return
    end
    
    RemovePlayerMoney(src, Config.HackPhone.CameraAccessCost)
    
    -- Log access
    MySQL.insert([[
        INSERT INTO phone_hack_logs (hacker_device_id, target_phone_number, hack_type, hack_data, success)
        VALUES (?, ?, 'camera_access', ?, 1)
    ]], {hackerDeviceId, targetNumber, json.encode({duration = Config.HackPhone.CameraAccessDuration})})
    
    SendNotify(src, 'Camera access granted (RP)', 'success')
    TriggerClientEvent('hackphone:client:cameraAccess', src, Config.HackPhone.CameraAccessDuration)
end)
